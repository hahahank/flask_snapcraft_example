{% extends "base.html" %}    
{% block title%} CPU Monitor{% endblock title%}

{% block content %}  
    <div class="container-fluid ">
      <div class="row vertical-spacing ">
        <div class="col-sm"></div>
        <div class="col-sm-center">
          <img class="rounded mx-auto responsive img-responsive" style="height:8em" src="{{ url_for('static', filename='assets/Logo.png') }}"/>
        </div>
        <div class="col-sm"></div>
      </div>
    </div>
    
   
    <div class="container-fluid vertical-spacing ">
      <div class="row">
        <div class="col-2"></div>
        <div class="col-8">
          
          <h3>System Info</h3>
          <span class="badge badge-primary"id="CPUReal">Physical Cores Number: </span>
          <span class="badge badge-primary"id="CPUVirtual">Virtual Cores Number: </span>
          <span class="badge badge-secondary"id="RAMinstalled">RAM installed: </span>
          <span class="badge badge-success"id="Architecture">Architecture: </span>
          <span class="badge badge-success"id="Kernel">Kernel Version: </span>
          <span class="badge badge-warning" id="Platform" >Platform Version: </span>
          <span class="badge badge-warning" id="Processor" >Processor: </span>
          
          
          
       
        </div>
        <div class="col-2">
          
          
       
        </div>
      </div>
    </div>

   
    <div class="container-fluid ">
      <div class="row vertical-spacing ">
        <div class="col-2"></div>
        <div class="col-8">
          <h3>System Monitor</h3>
          <label for="cpu"id="CPUlabel">Cpu Load % :</label>
          <div class="progress vertical-spacing">           
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="cpu" role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <label for="RAM"id="RAMlabel" >RAM usage % :</label>
          <div class="progress vertical-spacing">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="RAM" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <label for="DISK"id="DISKlabel" >DISK usage % :</label>
          <div class="progress vertical-spacing">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="DISK" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <label for="TEMP"id="TEMPlabel" >TEMP :</label>
          <div class="progress vertical-spacing">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="TEMP" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div>

         
          <div class="form-group">
            <label for="Thermal">Thermal Info:</label>
            <textarea class="form-control" rows="6" id="Thermal"  placeholder="Thermal Info" readonly></textarea>
          </div>
       
        </div>
        <div class="col-2"></div>
      </div>
    </div>

    <div class="container-fluid ">
      <div class="row vertical-spacing ">
        <div class="col-sm-2"></div>
        <div class="col-sm-4">
          <div  id="CPUgraph">
            <!-- Append graph here -->
          </div>
       
        </div>
        <div class="col-sm-4">
          
          <div  id="RAMgraph">
            <!-- Append graph here -->
          </div>
       
        </div>
        <div class="col-sm-2"></div>
      </div>
    </div>
   <div class="container my-3 bg-light">
      <div class="col-md-12 text-center">
          <button type="button" class="btn btn-primary" onclick="download_csv()">Download CSV</button> 
      </div>
  </div>
{% endblock content %}


{% block script%}
<script>
var graph1='CPUgraph';
var color1='#0079fc';
var data1='CPU';
var range1=[0, 100];
var title1='CPU %';

var graph2='RAMgraph';
var color2='#27a849';
var data2='RAM';
var range2=[0, 100];
var title2='RAM %';

var CpuX=[];
var CpuY=[];
var RamX=[];
var RamY=[];

function httpGet(theUrl){
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
      xmlHttp.send( null );
      return xmlHttp.responseText;
}

function populate(){
      var data=JSON.parse(httpGet(location.origin+"/cpumonitor/staticdata"));

      document.getElementById('CPUReal').innerHTML+=data.phcpu;
      document.getElementById('CPUVirtual').innerHTML+=data.vrcpu;
      document.getElementById('RAMinstalled').innerHTML+=data.ram;
      document.getElementById('Architecture').innerHTML+=data.architecture;
      document.getElementById('Kernel').innerHTML+=data.kernel;
      document.getElementById('Processor').innerHTML+=data.processor;
      document.getElementById('Platform').innerHTML+=data.platform;
      usageinfo();
}

function download_csv() {
        var csv = 'Cpu,CpuTime,Ram,Ramtime\n';
        for (let i = 0; i < CpuX.length; i++) {
            csv += CpuY[i] + ',' + CpuX[i]+ ',' +  RamY[i] + ',' + RamX[i];
            csv += "\n";
          }
        console.log(csv);
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        hiddenElement.target = '_blank';
        hiddenElement.download = 'CPU_RAM_usage.csv';
        hiddenElement.click();
}

function usageinfo() {
        var data=JSON.parse(httpGet(location.origin+"/cpumonitor/usagedata"));
        $('#cpu').attr('aria-valuenow', data.CPU).css('width', `${data.CPU}%`);
        $('#RAM').attr('aria-valuenow', data.RAM).css('width', `${data.RAM}%`);

        $('#Thermal').attr('placeholder', data.temp);

        $('#CPUlabel').attr('aria-valuenow', data.CPU).css('width', `${data.CPU}%`);
        $('#RAMlabel').attr('aria-valuenow', data.RAM).css('width', `${data.RAM}%`);
        document.getElementById('CPUlabel').innerHTML= 'Cpu Load : '+data.CPU +' %';
        document.getElementById('RAMlabel').innerHTML= 'RAM usage : '+data.RAM +' %';

        unix_timestamp=Date.now();
        var date = new Date(unix_timestamp * 1);
        // Hours part from the timestamp
        var hours = date.getHours();
        // Minutes part from the timestamp
        var minutes = "0" + date.getMinutes();
        // Seconds part from the timestamp
        var seconds = "0" + date.getSeconds();

        // Will display time in 10:30:23 format
        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);

        CpuY.push(data.CPU);
        RamY.push(data.RAM);
        CpuX.push(formattedTime);
        RamX.push(formattedTime);

        if (CpuX.length > 10000) {
            CpuY.shift();
            RamX.shift();
            RamY.shift();
        }

        loadMyGraph();
}



    function loadMyGraph(){
        loadGraph(graph1,color1,title1,range1,CpuX, CpuY);
        loadGraph(graph2,color2,title2,range2,CpuX, RamY);
    }

</script>
<script>

  window.onload = function(){
    populate();
    setInterval( usageinfo, 3000);
 // setInterval(    index_update,10000);
//  setInterval(    index_update_slow,30000)


  }
</script>

{% endblock script%}

